- name: Deploy TaskNotifier Application
  hosts: app_servers
  become: yes

  tasks:
    - name: Check if Docker is already installed
      command: docker --version
      register: docker_installed
      ignore_errors: yes
      changed_when: false

    - name: Display Docker status
      debug:
        msg: "Docker is {{ 'already installed' if docker_installed.rc == 0 else 'not installed, will install now' }}"

    - name: Update apt cache (only if Docker not installed)
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: docker_installed.rc != 0

    - name: Install Docker (only if not installed)
      apt:
        name:
          - docker.io
          - curl
        state: present
      when: docker_installed.rc != 0

    - name: Ensure Docker service is started and enabled
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Check if ubuntu user is in docker group
      command: groups ubuntu
      register: user_groups
      changed_when: false

    - name: Add ubuntu user to docker group (if not already)
      user:
        name: ubuntu
        groups: docker
        append: yes
      when: "'docker' not in user_groups.stdout"

    - name: Stop and remove existing containers
      shell: |
          docker stop tasknotifier-backend tasknotifier-frontend 2>/dev/null || true
          docker rm tasknotifier-backend tasknotifier-frontend 2>/dev/null || true
      changed_when: false

    - name: Pull backend image
      community.docker.docker_image:
        name: lakshan2002/tasknotifier-backend:latest
        source: pull
      retries: 3
      delay: 10
      register: backend_pull_result

    - name: Pull frontend image
      community.docker.docker_image:
        name: lakshan2002/tasknotifier-frontend:latest
        source: pull
      retries: 3
      delay: 10
      register: frontend_pull_result

    - name: Run backend container
      shell: |
        docker run -d \
          --name tasknotifier-backend \
          --restart always \
          -p 8080:8080 \
          -e SERVER_PORT=8080 \
          -e SPRING_PROFILES_ACTIVE=prod \
          -e Database_Host={{ lookup('env', 'DB_URL') | default('jdbc:mysql://localhost:3306/task_notifier', true) }} \
          -e Database_Username={{ lookup('env', 'DB_USERNAME') | default('root', true) }} \
          -e Database_Password={{ lookup('env', 'DB_PASSWORD') | mandatory('Environment variable DB_PASSWORD must be set') }} \
          -e SENDGRID_API_KEY={{ lookup('env', 'SENDGRID_API_KEY') | default('', true) }} \
          lakshan2002/tasknotifier-backend:latest

    - name: Wait for backend
      wait_for:
        port: 8080
        delay: 15
        timeout: 120

    - name: Run frontend container
      shell: |
        docker run -d \
          --name tasknotifier-frontend \
          --restart always \
          -p 5173:5173 \
          -e VITE_API_URL=http://{{ ansible_host }}:8080 \
          lakshan2002/tasknotifier-frontend:latest

    - name: Wait for frontend
      wait_for:
        port: 5173
        delay: 15
        timeout: 120

    - name: Show running containers
      shell: docker ps
      register: containers

    - name: Display deployment summary
      debug:
        msg:
          - "================================================"
          - "Deployment completed successfully!"
          - "================================================"
          - "Containers running:"
          - "{{ containers.stdout_lines }}"
          - ""
          - "Frontend URL: http://{{ ansible_host }}:5173"
          - "Backend URL: http://{{ ansible_host }}:8080"
          - "================================================"