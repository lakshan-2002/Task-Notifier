- name: Deploy TaskNotifier Application
  hosts: app_servers
  become: yes

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install Docker
      apt:
        name:
          - docker.io
          - curl
        state: present
        update_cache: yes

    - name: Start and enable Docker
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    - name: Stop and remove existing containers
      shell: |
        docker stop tasknotifier-backend tasknotifier-frontend || true
        docker rm tasknotifier-backend tasknotifier-frontend || true
      ignore_errors: yes

    - name: Pull backend image
      shell: docker pull lakshan2002/tasknotifier-backend:latest
      retries: 3
      delay: 10

    - name: Pull frontend image
      shell: docker pull lakshan2002/tasknotifier-frontend:latest
      retries: 3
      delay: 10

    - name: Run backend container
      shell: |
        docker run -d \
          --name tasknotifier-backend \
          --restart always \
          -p 8080:8080 \
          -e SERVER_PORT=8080 \
          -e SPRING_PROFILES_ACTIVE=prod \
          -e Database_Host={{ lookup('env', 'DB_URL') | default('jdbc:mysql://localhost:3306/task_notifier', true) }} \
          -e Database_Username={{ lookup('env', 'DB_USERNAME') | default('root', true) }} \
          -e Database_Password={{ lookup('env', 'DB_PASSWORD') | default('password', true) }} \
          -e SENDGRID_API_KEY={{ lookup('env', 'SENDGRID_API_KEY') | default('', true) }} \
          lakshan2002/tasknotifier-backend:latest

    - name: Wait for backend
      wait_for:
        port: 8080
        delay: 15
        timeout: 120

    - name: Run frontend container
      shell: |
        docker run -d \
          --name tasknotifier-frontend \
          --restart always \
          -p 5173:5173 \
          -e VITE_API_URL=http://{{ ansible_host }}:8080 \
          lakshan2002/tasknotifier-frontend:latest

    - name: Wait for frontend
      wait_for:
        port: 5173
        delay: 15
        timeout: 120

    - name: Show running containers
      shell: docker ps
      register: containers

    - name: Display deployment summary
      debug:
        msg:
          - "================================================"
          - "Deployment completed successfully!"
          - "================================================"
          - "Containers running:"
          - "{{ containers.stdout_lines }}"
          - ""
          - "Frontend URL: http://{{ ansible_host }}:5173"
          - "Backend URL: http://{{ ansible_host }}:8080"
          - "================================================"